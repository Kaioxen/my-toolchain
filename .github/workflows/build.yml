name: Build Clang 9 aarch64

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-20.04 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Download LLVM 9 Source
        run: |
          wget https://github.com/llvm/llvm-project/releases/download/llvmorg-9.0.0/llvm-9.0.0.src.tar.xz
          wget https://github.com/llvm/llvm-project/releases/download/llvmorg-9.0.0/clang-9.0.0.src.tar.xz
          tar -xf llvm-9.0.0.src.tar.xz
          tar -xf clang-9.0.0.src.tar.xz
          mv clang-9.0.0.src llvm-9.0.0.src/tools/clang

      - name: Configure CMake (Cross-Compile)
        run: |
          mkdir build && cd build
          cmake -G Ninja ../llvm-9.0.0.src \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_TARGETS_TO_BUILD="AArch64" \
            -DLLVM_DEFAULT_TARGET_TRIPLE=aarch64-linux-gnu \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DLLVM_ENABLE_PROJECTS="clang" \
            -DCMAKE_INSTALL_PREFIX=./install_dir

      - name: Build with Ninja
        run: |
          cd build
          ninja -j$(nproc)

      - name: Install and Package
        run: |
          cd build
          ninja install
          tar -czvf ../clang9-aarch64.tar.gz ./install_dir

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: clang9-binaries
          path: clang9-aarch64.tar.gz
