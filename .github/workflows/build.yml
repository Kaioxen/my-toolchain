name: Build Clang 9 aarch64 Debian

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: debian:bullseye

    steps:
      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu xz-utils wget python3 python3-dev build-essential libxml2-dev libncurses5-dev zlib1g-dev swig libedit-dev libpython3-dev git curl

      - name: Download LLVM 9 Source
        run: |
          wget https://releases.llvm.org/9.0.0/llvm-9.0.0.src.tar.xz
          wget https://releases.llvm.org/9.0.0/cfe-9.0.0.src.tar.xz
          tar -xf llvm-9.0.0.src.tar.xz
          tar -xf cfe-9.0.0.src.tar.xz
          mv cfe-9.0.0.src clang

      - name: Configure CMake
        run: |
          mkdir build && cd build
          cmake -G Ninja ../llvm-9.0.0.src \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_ENABLE_PROJECTS="clang" \
            -DLLVM_TARGETS_TO_BUILD="AArch64" \
            -DLLVM_DEFAULT_TARGET_TRIPLE=aarch64-linux-gnu \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_CXX_STANDARD=14 \
            -DCMAKE_CXX_FLAGS="-w -fpermissive" \
            -DPYTHON_EXECUTABLE=/usr/bin/python3 \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_ENABLE_BACKTRACES=OFF \
            -DLLVM_ENABLE_LIBXML2=OFF \
            -DLLVM_ENABLE_TERMINFO=OFF \
            -DCMAKE_INSTALL_PREFIX=../install_dir

      - name: Build and Install
        run: |
          cd build
          # Menggunakan j2 untuk menghindari kehabisan RAM di GitHub Actions
          ninja -j2
          ninja install

      - name: Strip Binaries
        run: |
          aarch64-linux-gnu-strip ../install_dir/bin/* || true

      - name: Archive Binaries
        run: |
          cd install_dir
          tar -czvf ../clang9-aarch64-debian.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: clang9-debian-aarch64
          path: clang9-aarch64-debian.tar.gz
