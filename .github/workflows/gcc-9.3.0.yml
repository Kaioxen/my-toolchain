name: Build GCC 9.3.0 Full Native AArch64 (Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"

      - name: Build Toolchain
        run: |
          docker run --rm -v $(pwd):/workspace ubuntu:18.04 bash -c "
            cd /workspace
            apt-get update
            apt-get install -y wget tar xz-utils build-essential \
                               gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
                               bison flex texinfo python3
            
            export PREFIX=/opt/gcc-9.3.0
            mkdir -p src build-binutils build-gcc install_dir

            # Download
            wget -q https://ftp.gnu.org/gnu/binutils/binutils-2.34.tar.xz
            wget -q https://ftp.gnu.org/gnu/gcc/gcc-9.3.0/gcc-9.3.0.tar.gz
            tar -xf binutils-2.34.tar.xz -C src
            tar -xf gcc-9.3.0.tar.gz -C src

            # 1. Build Binutils
            cd build-binutils
            ../src/binutils-2.34/configure --prefix=\$PREFIX --target=aarch64-linux-gnu --host=aarch64-linux-gnu --disable-nls
            make -j2 && make install DESTDIR=/workspace/install_dir
            cd ..

            # 2. Build GCC (The Real Challenge)
            cd src/gcc-9.3.0
            ./contrib/download_prerequisites
            cd ../../build-gcc
            ../src/gcc-9.3.0/configure \
                --prefix=\$PREFIX \
                --target=aarch64-linux-gnu \
                --host=aarch64-linux-gnu \
                --enable-languages=c,c++ \
                --disable-multilib \
                --disable-bootstrap \
                --disable-nls \
                --with-system-zlib
            
            # PAKAI J1 BIAR STABIL
            make -j1
            make install-strip DESTDIR=/workspace/install_dir
            
            # Packing
            if [ -f /workspace/install_dir\$PREFIX/bin/aarch64-linux-gnu-gcc ]; then
                cd /workspace/install_dir\$PREFIX
                tar -czvf /workspace/gcc-9.3.0-aarch64-FULL.tar.gz .
            else
                exit 1
            fi
          "

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: gcc-9.3.0-aarch64-FULL
          path: gcc-9.3.0-aarch64-FULL.tar.gz
